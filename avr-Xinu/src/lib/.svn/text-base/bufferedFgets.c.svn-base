/*
 *  ethgets.c
 *  
 *
 *  Created by Michael Minor on 1/13/11.
 *  Copyright 1990 2011 Michael M Minor. All rights reserved.
 *
 */
 
/*
 *---------------------------------------------------------------------------
 * open(), close(), gets() from a buffered stream
 *---------------------------------------------------------------------------
 */ 


#include <conf.h>
#include <kernel.h>
#include <name.h>
#include <io.h>

/*
 *---------------------------------------------------------------------------
 * ethgets - get a string from the device (file) attached to a stream
 *---------------------------------------------------------------------------
 */
 
char *ethgets(int dev, char *s, int n)
{
	register char *p = s;
	register int c;
	
	while (--n > 0 && (c = getbchar(dev)) != '\n' && c != SYSERR)
		*p++ = (char)c;
	if (c == SYSERR)
		{
		*p = '\0';
		return (char *)SYSERR;
		}
	if (c == '\n')
		*p++ = (char)c;
	*p = '\0';
	return s;
}

static struct stream
	{
	int n;
	char *bufp;
	char *buf;
	} stream[NDEVS];

int getbchar(int dev)
{

	if (stream[dev].n <= 0)		/* buffer is empty */
		{
		stream[dev].n = read(dev, stream[dev].buf, BUFSIZE);
		stream[dev].bufp = stream[dev].buf;
		}
	return ( (--stream[dev].n >= 0) ? *stream[dev].bufp++&CMASK : SYSERR );
}

/*
 *-----------------------------------------------------------------------------
 * bopen - open a file and attach it to a buffered stream, return its device
 *-----------------------------------------------------------------------------
 */
 
int bopen(char * file, char *mode)
{
	int dev;
	
	if ( (dev = open(NAMESPACE, file, mode) == SYSERR )
		return SYSERR;
	stream[dev].bufp = stream[dev].buf = (char *)getmem(BUFSIZE);
	stream[dev].n = 0;
	return dev;
}

/*
 *-----------------------------------------------------------------------------
 * bclose - close a buffered stream which is attached to a device, dev
 *-----------------------------------------------------------------------------
 */
 
int bclose(int dev)
{
	
	freemem(stream[dev].buf, BUFSIZE);
	close(dev);
}
